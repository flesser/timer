<html>
  <head>
    <title>Timer</title>
    <style>
      html, body {margin: 0; height: 100%; width: 100%; font-family: Arial;}
      h1 {font-size: 20px; text-align: center; position: fixed; width: 100%;}
      svg {height: 100%; width: 100%; transform: rotate(-90deg) scale(1, -1);}
      #fives {fill: white; stroke: black;}
      #ones {fill: transparent; stroke: black;}
      #red {fill: transparent; stroke: red; stroke-dasharray: 0,2000;}
      #goGitHub {position: absolute; right: 5px; top: 5px; text-decoration: none; color: black;}
    </style>
  </head>
  <body>
    <h1>Drag the mouse to setup timer</h1>
    <svg id="timer" viewBox="0 0 1000 1000">
    </svg>
    <audio id="sound" src="A-Tone.wav"></audio>

    <a id="goGitHub" href="https://github.com/jschirrmacher/timer" target="_blank">View on GitHub</a>

    <script>
      const match = location.search.match(/value=(\d+)/) || [0, 15 * 60]
      let value = Math.min(3600, Math.max(0, match[1]))
      const config = {
        radius: 130,
        tickWidth: 10,
        tickLength: 30,
        fivesLength: 60,
        redSpacing: 20
      }
      config.ticks = config.radius * 2 * Math.PI
      let inSet = false
      let startPos
      let playSound = 0

      const sound = document.getElementById('sound')
      const svg = document.getElementById('timer')
      svg.appendChild(createTicks('fives', 12, config.fivesLength))
      svg.appendChild(createTicks('fives', 60, config.tickLength))
      const timer = createCircle('red', config.radius, '')
      svg.appendChild(timer)

      updateTimer()
      window.setInterval(decrementToZero, 1000)
      bindHandler(svg, 'mousedown touchstart', handleStart)
      bindHandler(svg, 'mouseup touchend', handleEnd)
      bindHandler(svg, 'mousemove touchmove', handleMove)
      sound.addEventListener('ended', () => {
        if (--playSound) {
          sound.play()
        }
      })

      function bindHandler(el, events, listener) {
        events.split(' ').forEach(event => el.addEventListener(event, listener))
      }

      function handleStart(event) {
        inSet = true
        startPos = {x: event.clientX, y: event.clientY}
      }
      function handleMove(event) {
        if (inSet) {
          value = Math.min(3600, Math.max(0, (event.clientX - startPos.x + event.clientY - startPos.y) * 5))
          updateTimer()
        }
      }
      function handleEnd(event) {
        inSet = false
      }
      
      function updateTimer() {
        timer.setAttribute('style', 'stroke-width: ' + (config.radius) * 2 + '; stroke-dasharray: ' + (value / 3600 * config.ticks) + ',2000')
      }

      function decrementToZero() {
        if (value > 0) {
          value--
          updateTimer()
          if (value === 0) {
            playSound = 3
            sound.play()
          }
        }
      }

      function createTicks(id, count, length) {
        const radius = config.radius * 2 + config.redSpacing + length / 2
        const strokeArray = config.tickWidth + ',' + (radius * 2 * Math.PI / count - config.tickWidth)
        return createCircle(id, radius, length, strokeArray)
      }

      function createCircle(id, radius, strokeWidth, dashArray) {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle')
        circle.id = id
        circle.setAttribute('cx', 500)
        circle.setAttribute('cy', 500)
        circle.setAttribute('r', radius)
        circle.setAttribute('style', 'stroke-width: ' + strokeWidth + '; stroke-dasharray: ' + dashArray)
        return circle
      }
    </script>
  </body>
</html>